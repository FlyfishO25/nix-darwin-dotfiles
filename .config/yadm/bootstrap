#!/bin/bash

# Save this file as ~/.config/yadm/bootstrap and make it executable. It will
# execute all executable files (excluding templates and editor backups) in the
# ~/.config/yadm/bootstrap.d directory when run.

set -eu

# Install Homebrew and packages first
source "$HOME/.config/yadm/brew.sh"

# Set up emacs and neovim
source "$HOME/.config/yadm/editor/basictex.sh"
source "$HOME/.config/yadm/editor/emacs.sh"
source "$HOME/.config/yadm/editor/mu4e.sh"
source "$HOME/.config/yadm/editor/neovim.sh"

# Switch to fish
if [[ "$SHELL" != *"fish" ]]; then
    sudo sh -c 'echo $(which fish) >> /etc/shells'
    chsh -s $(which fish)
fi

# set up starship
source "$HOME/.config/yadm/prompt/starship.sh"

# Directory to look for bootstrap executables in
BOOTSTRAP_D="${BASH_SOURCE[0]}.d"

if [[ ! -d "$BOOTSTRAP_D" ]]; then
    echo "Error: bootstrap directory '$BOOTSTRAP_D' not found" >&2
    exit 1
fi

find "$BOOTSTRAP_D" -type f | sort | while IFS= read -r bootstrap; do
    if [[ -x "$bootstrap" && ! "$bootstrap" =~ "##" && ! "$bootstrap" =~ "~$" ]]; then
        if ! "$bootstrap"; then
            echo "Error: bootstrap '$bootstrap' failed" >&2
            exit 1
        fi
    fi
done
